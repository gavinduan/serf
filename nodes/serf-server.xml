<?xml version="1.0" standalone="no"?>

<kickstart>

	<description>
	serf
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	</copyright>

<post>

# setup encryption key to talk to the other agent in the cluster
encryption=`cat /etc/411-security/shared.key |grep -v BEGIN |grep -v END | base64 -d |dd bs=1 count=16 |base64`


<file name="/etc/serf/encryptionkey.json" perms="0600">
{
    "encrypt_key": "$encryption"
}
</file>


# only frontend needs to be stateful (event lost while the daemon
# was down will be replayed when it is back up)
# all other nodes if they lose it is ok so no need to snapshot
mkdir -p /var/opt/rocks/serf/

private_ip=`rocks list host interface &hostname; output-col=subnet,ip | grep ^private | awk '{print $2}'`
<file name="/etc/serf/serf.json" perms="0600">
  "snapshot_path": "/var/opt/rocks/serf/serf.snap",
  "rejoin_after_leave": true,
  "replay_on_join": true,
  "bind": "$private_ip",
  "retry_join": ["&Kickstart_PrivateHostname;"]
</file>



chkconfig rocks-serf on
</post>
</kickstart>
